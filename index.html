<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>営業実績ダッシュボード</title>
    <!-- Tailwind CSSを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ReactとBabelを読み込み (JSXをブラウザで解釈するため) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chart.jsと関連ライブラリを読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- PapaParse (CSV解析ライブラリ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

</head>
<body class="bg-gray-100">
    <!-- Reactアプリケーションを描画するコンテナ -->
    <div id="root"></div>

    <!-- Reactコンポーネントのコード -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Chart.js のすべての要素を登録
        Chart.register(...Chart.registerables);

        // --- ヘルパー関数 ---

        // 通貨文字列を数値に変換する関数
        const parseCurrency = (value) => {
            if (typeof value !== 'string') return 0;
            // '¥', ',', '"' を削除して数値に変換
            return Number(value.replace(/['¥",]/g, ''));
        };

        // 数値を円通貨形式にフォーマットする関数
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value || 0);
        };

        // --- Reactコンポーネント ---

        // KPIカードコンポーネント
        const KpiCard = ({ title, value, subValue, subLabel, isLoading }) => (
            <div className="bg-white p-6 rounded-xl shadow-md flex flex-col justify-between min-h-[120px]">
                <div>
                    <h3 className="text-sm font-medium text-gray-500">{title}</h3>
                    {isLoading ? (
                        <div className="h-8 bg-gray-200 rounded-md animate-pulse mt-2"></div>
                    ) : (
                        <p className="mt-1 text-3xl font-semibold text-gray-900">{value}</p>
                    )}
                </div>
                {subValue && (
                    <div className="mt-4">
                        <p className={`text-lg font-medium ${subValue.includes('-') ? 'text-red-500' : 'text-green-600'}`}>
                            {subValue}
                        </p>
                        <p className="text-xs text-gray-500">{subLabel}</p>
                    </div>
                )}
            </div>
        );

        // チャートコンポーネントのラッパー
        const ChartComponent = ({ type, data, options, title }) => {
            const chartRef = useRef(null);

            useEffect(() => {
                if (!chartRef.current) return;
                const chart = new Chart(chartRef.current, {
                    type,
                    data,
                    options,
                });
                return () => chart.destroy();
            }, [type, data, options]);

            return (
                <div className="bg-white p-6 rounded-xl shadow-md">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">{title}</h3>
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        };


        // メインのAppコンポーネント
        const App = () => {
            // --- State定義 ---
            const [salesData, setSalesData] = useState([]);
            const [selectedFy, setSelectedFy] = useState('FY2025');
            const [isLoading, setIsLoading] = useState(true);

            // --- データ取得と前処理 ---
            useEffect(() => {
                const fetchData = async () => {
                    setIsLoading(true);
                    try {
                        // CSVファイルのパス
                        const salesDataPath = '/fs/営業企画KPI管理シート元_データ - レポート用データ.csv';

                        const response = await fetch(salesDataPath);
                        const salesText = await response.text();

                        // CSVをパース
                        const salesResult = Papa.parse(salesText, { header: true, skipEmptyLines: true }).data;

                        // データを整形してStateにセット
                        const processedSales = salesResult
                            .map(row => ({
                                date: new Date(row['日付']),
                                member: row['フリーランスメンバー'],
                                company: row['企業名'],
                                type: row['新規 or 既存？'] || '不明',
                                product: row['プロダクト'],
                                branch: row['所属支社'],
                                team: row['所属チーム'],
                                metric: row['項目名'],
                                value: parseCurrency(row['数値']),
                            }))
                            .filter(row => row.date instanceof Date && !isNaN(row.date) && row.value !== null);

                        setSalesData(processedSales);
                    } catch (error) {
                        console.error("データの読み込みに失敗しました:", error);
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchData();
            }, []);

            // --- データ加工・集計 (useMemoでパフォーマンス最適化) ---

            // 選択された年度のデータをフィルタリング
            const filteredData = useMemo(() => {
                if (!selectedFy) return [];
                const year = parseInt(selectedFy.replace('FY', ''));
                // FY2025は2024年12月〜2025年11月
                const startDate = new Date(year - 1, 11, 1); 
                const endDate = new Date(year, 11, 1);
                
                return salesData.filter(d => d.date >= startDate && d.date < endDate);
            }, [salesData, selectedFy]);
            

            // KPIサマリー用のデータを計算
            const kpiSummary = useMemo(() => {
                const sales = filteredData
                    .filter(d => d.metric === '受注金額(税抜)')
                    .reduce((sum, d) => sum + d.value, 0);

                const profit = filteredData
                    .filter(d => d.metric === '合計粗利金額')
                    .reduce((sum, d) => sum + d.value, 0);

                return { sales, profit };
            }, [filteredData]);

            // 月次推移グラフ用のデータ
            const monthlyTrendData = useMemo(() => {
                const months = {};
                const year = parseInt(selectedFy.replace('FY', ''));

                // 12ヶ月分のラベルを生成 (例: FY2025 -> 2024/12, 2025/01, ...)
                const labels = Array.from({ length: 12 }, (_, i) => {
                    const month = (11 + i) % 12;
                    const d = new Date(year - 1, month + 1, 1);
                    return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}`;
                });

                labels.forEach(label => {
                    months[label] = { newSales: 0, existingSales: 0, newProfit: 0, existingProfit: 0 };
                });

                filteredData.forEach(d => {
                    const key = `${d.date.getFullYear()}/${String(d.date.getMonth() + 1).padStart(2, '0')}`;
                    if (months[key]) {
                        if (d.metric === '受注金額(税抜)') {
                            if (d.type === '新規') months[key].newSales += d.value;
                            else months[key].existingSales += d.value;
                        } else if (d.metric === '合計粗利金額') {
                            if (d.type === '新規') months[key].newProfit += d.value;
                            else months[key].existingProfit += d.value;
                        }
                    }
                });
                
                return {
                    labels,
                    datasets: [
                        { type: 'bar', label: '新規売上', data: labels.map(l => months[l]?.newSales || 0), backgroundColor: 'rgba(54, 162, 235, 0.7)', stack: 'sales' },
                        { type: 'bar', label: '既存売上', data: labels.map(l => months[l]?.existingSales || 0), backgroundColor: 'rgba(54, 162, 235, 0.3)', stack: 'sales' },
                        { type: 'bar', label: '新規粗利', data: labels.map(l => months[l]?.newProfit || 0), backgroundColor: 'rgba(255, 99, 132, 0.7)', stack: 'profit' },
                        { type: 'bar', label: '既存粗利', data: labels.map(l => months[l]?.existingProfit || 0), backgroundColor: 'rgba(255, 99, 132, 0.3)', stack: 'profit' },
                    ]
                };
            }, [filteredData, selectedFy]);

            // 支社別データ
            const branchData = useMemo(() => {
                const branches = {};
                filteredData
                    .filter(d => d.metric === '受注金額(税抜)')
                    .forEach(d => {
                        const branchName = d.branch || '未所属';
                        branches[branchName] = (branches[branchName] || 0) + d.value;
                    });
                const sortedBranches = Object.entries(branches).sort(([, a], [, b]) => b - a);
                return {
                    labels: sortedBranches.map(([label]) => label),
                    datasets: [{
                        data: sortedBranches.map(([, value]) => value),
                        backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#6366F1', '#3B82F6', '#8B5CF6'],
                    }]
                };
            }, [filteredData]);

            // 担当者ランキングデータ
            const memberRankingData = useMemo(() => {
                const members = {};
                filteredData
                    .filter(d => d.metric === '受注金額(税抜)')
                    .forEach(d => {
                        const memberName = d.member || '不明';
                        members[memberName] = (members[memberName] || 0) + d.value;
                    });
                const sortedMembers = Object.entries(members).sort(([, a], [, b]) => b - a).slice(0, 10);
                return {
                    labels: sortedMembers.map(([label]) => label),
                    datasets: [{
                        label: '受注金額',
                        data: sortedMembers.map(([, value]) => value),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                    }]
                };
            }, [filteredData]);
            
            // プロダクト別データ
            const productData = useMemo(() => {
                const products = {};
                filteredData
                    .filter(d => d.metric === '受注金額(税抜)')
                    .forEach(d => {
                        const productName = d.product || '不明';
                        products[productName] = (products[productName] || 0) + d.value;
                    });
                const sortedProducts = Object.entries(products).sort(([, a], [, b]) => b - a).slice(0, 10);
                return {
                    labels: sortedProducts.map(([label]) => label),
                    datasets: [{
                        label: '受注金額',
                        data: sortedProducts.map(([, value]) => value),
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1,
                    }]
                };
            }, [filteredData]);


            // --- チャートオプション ---
            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: value => `${value / 10000}万円`
                        }
                    }
                }
            };
            
            // --- レンダリング ---
            return (
                <div className="bg-gray-100 min-h-screen font-sans">
                    <div className="container mx-auto p-4 md:p-8">
                        {/* ヘッダー */}
                        <header className="flex flex-col md:flex-row justify-between items-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-800">営業実績ダッシュボード</h1>
                            <div className="mt-4 md:mt-0">
                                <select
                                    value={selectedFy}
                                    onChange={(e) => setSelectedFy(e.target.value)}
                                    className="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                >
                                    <option value="FY2025">FY2025</option>
                                    <option value="FY2024">FY2024</option>
                                    <option value="FY2023">FY2023</option>
                                    <option value="FY2022">FY2022</option>
                                </select>
                            </div>
                        </header>

                        {/* KPIサマリー */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <KpiCard 
                                title="総売上" 
                                value={formatCurrency(kpiSummary.sales)} 
                                isLoading={isLoading}
                            />
                            <KpiCard 
                                title="総粗利" 
                                value={formatCurrency(kpiSummary.profit)} 
                                isLoading={isLoading}
                            />
                            <KpiCard 
                                title="新規売上" 
                                value={formatCurrency(filteredData.filter(d => d.type === '新規' && d.metric === '受注金額(税抜)').reduce((sum, d) => sum + d.value, 0))} 
                                isLoading={isLoading}
                            />
                            <KpiCard 
                                title="既存売上" 
                                value={formatCurrency(filteredData.filter(d => d.type !== '新規' && d.metric === '受注金額(税抜)').reduce((sum, d) => sum + d.value, 0))} 
                                isLoading={isLoading}
                            />
                        </div>

                        {/* メインコンテンツエリア */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* 月次推移 */}
                            <div className="lg:col-span-3 h-96">
                                <ChartComponent 
                                    type="bar" 
                                    data={monthlyTrendData} 
                                    options={{...commonChartOptions, scales: { x: { stacked: true }, y: { stacked: true } }}}
                                    title="月次売上・粗利推移"
                                />
                            </div>

                            {/* 支社別・担当者別 */}
                            <div className="lg:col-span-1 h-96">
                                 <ChartComponent 
                                    type="doughnut" 
                                    data={branchData} 
                                    options={{...commonChartOptions, scales: {}}}
                                    title="支社別 売上構成"
                                />
                            </div>
                            <div className="lg:col-span-2 h-96">
                                <ChartComponent 
                                    type="bar" 
                                    data={memberRankingData} 
                                    options={{...commonChartOptions, indexAxis: 'y'}}
                                    title="担当者別 売上ランキング (TOP 10)"
                                />
                            </div>
                            
                            {/* プロダクト別 */}
                            <div className="lg:col-span-3 h-96 mt-6">
                                 <ChartComponent 
                                    type="bar" 
                                    data={productData} 
                                    options={commonChartOptions}
                                    title="プロダクト別 売上 (TOP 10)"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ReactアプリケーションをDOMにレンダリング
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
